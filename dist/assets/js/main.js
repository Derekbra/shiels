var makeAShape=window.makeAShape||{};makeAShape.ShapeController=Backbone.Router.extend({routes:{dates:"showDates",start:"showStart",colors:"showColors",preview:"showPreview",note:"showNote",finish:"showFinish",back:"triggerBack","*path":"showStart"},initialize:function(){this.dateSelector=new makeAShape.dateCreator(".date-selector"),$(".page-nav a").click(this.scrollTo),$(".back-to-top").click(this.scrollTo)},scrollTo:function(a){a.preventDefault();var b=$(this).attr("href"),c="#"==b?0:$(b).position().top;$("body").animate({scrollTop:c})},showNavView:function(a){$(".nav-views").children().addClass("hidden"),$(a,".nav-views").removeClass("hidden")},showDates:function(){this.showNavView(".dates")},showStart:function(){this.showNavView(".start")},showNote:function(){this.showNavView(".note"),$("textarea").focus()},showColors:function(){this.controlData=this.dateSelector.getDates(),this.renderColorSelectors(),this.showNavView(".colors")},showPreview:function(){this.showNavView(".preview"),$("body").trigger("makeashape:clear");var a=this.createColorData(),b=0;for(key in this.controlData)this.controlData[key].colors=a[b],$("body").trigger("makeashape:addDates",[this.controlData[key]]),b++},showFinish:function(){$("body").trigger("makeashape:renderNote",$(".note-box").val()),this.showNavView(".finish")},triggerBack:function(){window.history.back()},createColorData:function(){for(var a=$(".color-set"),b=[],c=0;c<a.length;c++){for(var d=[],e=$(a[c]).children(),f=0;f<e.length;f++)$(e[f]).data("color")&&d.push($(e[f]).data("color"));b.push(d)}return b},renderColorSelectors:function(){$(".color-selector").html("");for(key in this.controlData){var a=this.controlData[key].points,b="<div class='color-set'>";b+="<span class='date-title DINWeb left'>Date</span>",$(".color-selector").append(b);for(var c=$(".color-set"),d=0;d<a.length;d++){var e=new makeAShape.ColorPicker({number:a[d]});$(c[c.length-1]).append(e.render().el),e.initializeColorPicker()}$(".color-selector").append("</div>")}}});var makeAShape=window.makeAShape||{};makeAShape.ColorPicker=Backbone.View.extend({tagName:"div",className:"color-container left",initialize:function(a){_.bindAll(this,"onColorSelected"),this.number=a.number},render:function(){var a="<span class='date-num DINWeb'>"+this.number+"</span>";return a+="<input/>",$(this.el).html(a),$(this.el).attr("data-color","#333"),this},initializeColorPicker:function(){$("input",this.el).spectrum({color:"#333",hide:this.onColorSelected,showInput:!1,showPaletteOnly:!1,showPalette:!0,palette:[["#FF4040","#FF7373","#BF3030","#BF7130","#A64B00"],["#FF9640","#1D7373","#006363","#33CCCC","#55CCCC"]]})},onColorSelected:function(a){$(this.el).attr("data-color",a.toHexString())}});var makeAShape=window.makeAShape||{};makeAShape.dateCreator=function(a){this.el=$(a),this.populateFields()},makeAShape.dateCreator.prototype.populateFields=function(){this.populate(".days",0,31),this.populate(".months",0,12),this.populateYears((new Date).getFullYear())},makeAShape.dateCreator.prototype.populate=function(a,b,c){for(var d=$(a,$(this.el)),e=0;e<d.length;e++){var f=new Option("--","--");d[e].options[0]=f;for(var g=b;c>g;g++){var f=new Option(g+1,g+1);d[e].options[g+1]=f}}$(a).append("<span class='sp-dd'>â–¼</span>")},makeAShape.dateCreator.prototype.populateYears=function(a){for(var b=$(".years",$(this.el)),c=a,d=0;d<b.length;d++){var e=new Option("----","----");b[d].options[0]=e;for(var f=0;120>f;f++){var e=new Option(c,c);b[d].options[f+1]=e,c--}c=a}},makeAShape.dateCreator.prototype.getDates=function(){for(var a={},b="dateSet",c=0,d=$(".date-set",$(this.el)),e=0;e<d.length;e++){var f=this.createDateArray(d[e]);null!=f&&(a[b+c]={},a[b+c].points=f,c++)}return a},makeAShape.dateCreator.prototype.createDateArray=function(a){var b=[],c=String($(".days",a).val()),d=String($(".months",a).val()),e=String($(".years",a).val());return"--"==c||"--"==d||"----"==e?null:(1==c.length&&(c="0"+c),1==d.length&&(d="0"+d),b.push(c),b.push(d),b.push(e.substr(0,2)),b.push(e.substr(2,2)),b)},paper.install(window);var makeAShape=window.makeAShape||{};makeAShape.ShapeCreator=function(a,b,c){this.init(c),this.paper=c,this.width=a,this.height=b,this.dragging=!1,this.currentScale=1,this.currentPosition={x:0,y:0},this.startingBounds={},this.currentTextOffset,this.paths=[];var d=new Path.Rectangle(c.view.bounds);d.fillColor="white",this.setupListeners()},makeAShape.ShapeCreator.prototype.clearCanvas=function(){this.paper.project.activeLayer.hasChildren()&&this.paper.project.activeLayer.removeChildren(),this.currentTextOffset=null,this.paths=[]},makeAShape.ShapeCreator.prototype.addDates=function(a){this.reset();var b=new Path,c=this,d=[a.points],e=a.colors;this.eachDate(d,function(a,d){c.drawPoint(b,c.coupleToArray(d[a]))}),b.closed=!0,b.style={fillColor:"#333"},b.opacity=.7,this.paths.push(b),this.drawDuplicates(b,d,e),this.group=new Group(this.paths),this.currentPosition=this.group.position,this.renderDateText(d),this.redraw(),this.startingBounds=this.group.bounds},makeAShape.ShapeCreator.prototype.drawDuplicates=function(a,b,c){var d=this;this.eachDate(b,function(b,e){var f=d.coupleToPoint(e[0]),g=a.clone();g.opacity=.7,d.paths.push(g),g.fillColor=c[b],g.rotate(-1*e[b],f)})},makeAShape.ShapeCreator.prototype.drawPoint=function(a,b){a.add(this.coupleToPoint(b))},makeAShape.ShapeCreator.prototype.renderDateText=function(a){this.currentTextOffset||(this.currentTextOffset=$("#shapeCanvas").height()-15),this.currentTextOffset-=15;var b=a[0],c=new PointText({point:[30,this.currentTextOffset],content:b[0]+"/"+b[1]+"/"+b[2]+b[3],fillColor:"#949494",fontSize:12,fontWeight:"bold"});c.bringToFront()},makeAShape.ShapeCreator.prototype.renderNote=function(a){this.currentTextOffset||(this.currentTextOffset=$("#shapeCanvas").height()-15);var b=this.wordWrap(a,40,"\n"),c=this.currentTextOffset;c-=15*b.numBreaks+30,this.note&&this.note.remove(),this.note=new PointText({point:[30,c],content:b.brokenString,fillColor:"#d1d1d1",fontSize:12,fontWeight:"bold"}),this.borderLine=new Path,this.borderLine.strokeColor="#b4b3b4",this.borderLine.add(new Point(30,c-15)),this.borderLine.add(new Point(220,c-15)),this.note.bringToFront(),this.redraw()},makeAShape.ShapeCreator.prototype.setupListeners=function(){_this=this;var a=10;$("a.scale-up").click(function(a){_this.scaleGroup(a,.1)}),$("a.scale-down").click(function(a){_this.scaleGroup(a,-.1)}),$("a.rotate-clock").click(function(a){_this.rotateGroup(a,45)}),$("a.rotate-anticlock").click(function(a){_this.rotateGroup(a,-45)}),$("a.move-up").click(function(b){_this.currentPosition.y-=a,_this.moveGroup(b,_this.currentPosition)}),$("a.move-down").click(function(b){_this.currentPosition.y+=a,_this.moveGroup(b,_this.currentPosition)}),$("a.move-left").click(function(b){_this.currentPosition.x-=a,_this.moveGroup(b,_this.currentPosition)}),$("a.move-right").click(function(b){_this.currentPosition.x+=a,_this.moveGroup(b,_this.currentPosition)}),$("body").bind("makeashape:addDates",function(a,b){_this.addDates(b)}),$("body").bind("makeashape:clear",function(a,b){_this.clearCanvas()}),$("body").bind("makeashape:renderNote",function(a,b){_this.renderNote(b)}),$("body").bind("makeashape:reset",function(a,b){_this.reset()})},makeAShape.ShapeCreator.prototype.reset=function(){null!=this.group&&(this.currentScale=1,this.group.bounds=this.startingBounds,this.group.rotate(360),this.redraw())},makeAShape.ShapeCreator.prototype.wordWrap=function(a,b,c,d){if(c=c||"\n",b=b||75,d=d||!1,!a)return a;var e=".{1,"+b+"}(\\s|$)"+(d?"|.{"+b+"}|.+$":"|\\S+?(\\s|$)"),f=a.match(RegExp(e,"g")).join(c),g=f.match(/[^\n]*\n[^\n]*/gi),h=0;return g&&(h=g.length),{brokenString:f,numBreaks:h}},makeAShape.ShapeCreator.prototype.coupleToArray=function(a){var b=[],c=(""+a).split("");for(i=0;i<c.length;i++)b.push(+c[i]);return b},makeAShape.ShapeCreator.prototype.coupleToPoint=function(a){var b=new Point(this.width/10/2,this.height/10/2);return new Point(a[0]*(this.width/10)+b.x,a[1]*(this.height/10)+b.y)},makeAShape.ShapeCreator.prototype.eachDate=function(a,b){for(i=0;i<a.length;i++){var c=a[i];for(j=0;j<c.length;j++)b(j,c)}},makeAShape.ShapeCreator.prototype.scaleGroup=function(a,b){a.preventDefault(),this.group.bounds.width=this.startingBounds.width,this.group.bounds.height=this.startingBounds.height,this.currentScale+=b,this.currentScale>2&&(this.currentScale=2),this.currentScale<.6&&(this.currentScale=.6),this.group.bounds.width*=this.currentScale,this.group.bounds.height*=this.currentScale,this.redraw()},makeAShape.ShapeCreator.prototype.rotateGroup=function(a,b){a.preventDefault(),this.group.rotate(b),this.redraw()},makeAShape.ShapeCreator.prototype.moveGroup=function(a,b){a.preventDefault();var c=$("#shapeCanvas").width(),d=$("#shapeCanvas").height(),e=new Point(Math.max(0,Math.min(b.x,c)),Math.max(0,Math.min(b.y,d)));this.group.position=e,this.currentPosition=this.group.position,this.redraw()},makeAShape.ShapeCreator.prototype.redraw=function(){this.paper.view.draw(!0)},makeAShape.ShapeCreator.prototype.scaleAndReturnSVG=function(a,b,c){var d="0 0 "+$("canvas").width()+" "+$("canvas").height(),e=a;return e.setAttribute("viewBox",d),e.setAttribute("width",b),e.setAttribute("height",c),a},makeAShape.ShapeCreator.prototype.drawGrid=function(){var a=this.height/10,b=this.width/10;for(i=0;i<10;i++){var c=new Path;c.strokeColor="#999",c.opacity=.2,c.add(new Point(0,a*i)),c.add(new Point(this.width,a*i))}for(j=0;j<10;j++){var d=new Path;d.strokeColor="#999",d.opacity=.2,d.add(new Point(b*j,0)),d.add(new Point(b*j,this.height))}},makeAShape.ShapeCreator.prototype.init=function(a){a.inject({myRotationApply:function(a,b){a.rotate(b),a.my_rotation+=b,a.my_rotation>=360&&(a.my_rotation-=360),a.my_rotation<0&&(a.my_rotation+=360)},injectCustomRotation:function(b){b.inject({myRotate:function(b){a.myRotationApply(this,b)},my_rotation:0})}}),a.inject({myScaleApply:function(a,b){a.my_scale=b,a.scale(b)},injectCustomScale:function(b){b.inject({myScale:function(b){a.myScaleApply(this,b)},my_scale:1})}}),a.injectCustomRotation(a.Group),a.injectCustomScale(a.Group)};